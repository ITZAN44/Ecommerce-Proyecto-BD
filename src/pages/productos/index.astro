---
import Layout from '../../layouts/Layout.astro';
import Icon from '../../components/Icon.astro';
import { query } from '../../lib/db';
import type { Producto, Categoria } from '../../lib/types';

let productos: any[] = [];
let categorias: Categoria[] = [];
let error = '';

try {
  const resultProductos = await query(`
    SELECT p.producto_id, p.categoria_id, p.nombre_producto,
           p.descripcion_larga as descripcion,
           p.estado, p.fecha_creacion,
           c.nombre_categoria,
           c.estado as estado_categoria,
           COALESCE(s.cantidad_en_stock, 0) as stock_actual,
           COALESCE(s.precio_unitario, 0) as precio
    FROM productos p
    LEFT JOIN categorias c ON p.categoria_id = c.categoria_id
    LEFT JOIN stock s ON p.producto_id = s.producto_id
    WHERE c.estado = 'activo'
    ORDER BY p.producto_id DESC
  `);
  productos = resultProductos.rows;

  const resultCategorias = await query('SELECT * FROM categorias WHERE estado = $1 ORDER BY nombre_categoria', ['activo']);
  categorias = resultCategorias.rows;
} catch (err) {
  error = 'Error al cargar productos: ' + (err as Error).message;
  console.error(err);
}

const activos = productos.filter(p => p.estado === 'activo').length;
const inactivos = productos.filter(p => p.estado === 'inactivo').length;
const valorTotal = productos.reduce((sum, p) => sum + (parseFloat(p.precio) * (p.stock_actual || 0)), 0);
---

<Layout title="Productos">
  <div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8" style="background-color: var(--bg-primary);">
    <div class="max-w-7xl mx-auto">

      <!-- Header -->
      <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 class="text-4xl font-bold flex items-center gap-3" style="color: var(--text-primary);">
              <Icon name="shopping-bag" size={40} style="color: var(--accent-purple);" />
              <span>Productos</span>
            </h1>
            <p class="mt-2 text-base" style="color: var(--text-secondary);">Gestiona el cat√°logo de productos de tu tienda</p>
          </div>
          <div class="flex gap-3">
            <button
              onclick="document.getElementById('modal-ajustar-precios').classList.remove('hidden')"
              class="btn-secondary inline-flex items-center gap-2"
              style="background-color: rgba(245, 158, 11, 0.1); color: var(--accent-yellow); border: 1px solid var(--accent-yellow);"
            >
              <Icon name="currency-dollar" size={20} />
              <span>Ajustar Precios</span>
            </button>
            <button
              onclick="document.getElementById('modal-crear').classList.remove('hidden')"
              class="btn-primary inline-flex items-center gap-2"
            >
              <Icon name="plus" size={20} />
              <span>Nuevo Producto</span>
            </button>
          </div>
        </div>
      </div>

      {error && (
        <div class="mb-6 p-4 rounded-lg" style="background-color: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--accent-red);">
          <div class="flex items-center gap-3">
            <Icon name="exclamation-triangle" size={24} style="color: var(--accent-red);" />
            <p class="font-medium" style="color: var(--accent-red);">{error}</p>
          </div>
        </div>
      )}

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium uppercase tracking-wide mb-2" style="color: var(--text-secondary);">Total Productos</p>
              <p class="text-3xl font-bold" style="color: var(--text-primary);">{productos.length}</p>
            </div>
            <div class="p-4 rounded-xl" style="background-color: rgba(139, 92, 246, 0.1);">
              <Icon name="shopping-bag" size={32} style="color: var(--accent-purple);" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium uppercase tracking-wide mb-2" style="color: var(--text-secondary);">Activos</p>
              <p class="text-3xl font-bold" style="color: var(--accent-green);">{activos}</p>
            </div>
            <div class="p-4 rounded-xl" style="background-color: rgba(16, 185, 129, 0.1);">
              <Icon name="check-circle" size={32} style="color: var(--accent-green);" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium uppercase tracking-wide mb-2" style="color: var(--text-secondary);">Inactivos</p>
              <p class="text-3xl font-bold" style="color: var(--accent-red);">{inactivos}</p>
            </div>
            <div class="p-4 rounded-xl" style="background-color: rgba(239, 68, 68, 0.1);">
              <Icon name="x-circle" size={32} style="color: var(--accent-red);" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium uppercase tracking-wide mb-2" style="color: var(--text-secondary);">Valor Total</p>
              <p class="text-3xl font-bold" style="color: var(--accent-blue);">${valorTotal.toFixed(2)}</p>
            </div>
            <div class="p-4 rounded-xl" style="background-color: rgba(59, 130, 246, 0.1);">
              <Icon name="currency-dollar" size={32} style="color: var(--accent-blue);" />
            </div>
          </div>
        </div>
      </div>

      <!-- Table Card -->
      <div class="card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead style="border-bottom: 2px solid var(--border-primary);">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">
                  Producto
                </th>
                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">
                  Categor√≠a
                </th>
                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">
                  Descripci√≥n
                </th>
                <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">
                  Precio
                </th>
                <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">
                  Stock
                </th>
                <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">
                  Estado
                </th>
                <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody>
              {productos.length === 0 ? (
                <tr>
                  <td colspan="7" class="px-6 py-12 text-center">
                    <div class="flex flex-col items-center justify-center">
                      <Icon name="shopping-bag" size={64} style="color: var(--text-muted);" class="mb-4" />
                      <p class="text-lg font-medium mb-1" style="color: var(--text-secondary);">No hay productos registrados</p>
                      <p class="text-sm" style="color: var(--text-muted);">Crea tu primer producto para comenzar</p>
                    </div>
                  </td>
                </tr>
              ) : (
                productos.map((prod) => (
                  <tr class="border-b transition-colors"
                      style="border-color: var(--border-primary);"
                      onmouseenter="this.style.backgroundColor='var(--bg-tertiary)'"
                      onmouseleave="this.style.backgroundColor='transparent'">
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-3">
                        <div class="shrink-0 h-12 w-12 rounded-xl flex items-center justify-center"
                             style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));">
                          <span class="text-white font-bold text-xl">{prod.nombre_producto.charAt(0).toUpperCase()}</span>
                        </div>
                        <div>
                          <div class="text-sm font-bold" style="color: var(--text-primary);">{prod.nombre_producto}</div>
                          <div class="text-xs" style="color: var(--text-muted);">ID: {prod.producto_id}</div>
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium"
                            style="background-color: rgba(139, 92, 246, 0.1); color: var(--accent-purple); border: 1px solid var(--accent-purple);">
                        {prod.nombre_categoria || 'Sin categor√≠a'}
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="text-sm max-w-md truncate" style="color: var(--text-secondary);">
                        {prod.descripcion ? (
                          <span>{prod.descripcion}</span>
                        ) : (
                          <span class="italic" style="color: var(--text-muted);">Sin descripci√≥n</span>
                        )}
                      </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="text-sm font-bold" style="color: var(--accent-green);">
                        ${parseFloat(prod.precio).toFixed(2)}
                      </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span class={`inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-semibold`}
                            style={prod.stock_actual > 10
                              ? 'background-color: rgba(16, 185, 129, 0.1); color: var(--accent-green); border: 1px solid var(--accent-green);'
                              : prod.stock_actual > 0
                                ? 'background-color: rgba(245, 158, 11, 0.1); color: var(--accent-yellow); border: 1px solid var(--accent-yellow);'
                                : 'background-color: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red);'}>
                        {prod.stock_actual || 0} unidades
                      </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span class={`inline-flex items-center space-x-1 px-2.5 py-0.5 rounded-md text-xs font-medium`}
                            style={prod.estado === 'activo'
                              ? 'background-color: rgba(16, 185, 129, 0.1); color: var(--accent-green); border: 1px solid var(--accent-green);'
                              : 'background-color: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red);'}>
                        <Icon name={prod.estado === 'activo' ? 'check-circle' : 'x-circle'} size={12} />
                        <span>{prod.estado === 'activo' ? 'Activo' : 'Inactivo'}</span>
                      </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="flex justify-end gap-2">
                        <button
                          onclick={`editarProducto(${JSON.stringify(prod)})`}
                          class="p-2 rounded-lg transition-all"
                          style="background-color: var(--bg-tertiary); color: var(--accent-blue);"
                          onmouseenter="this.style.backgroundColor='var(--bg-hover)'"
                          onmouseleave="this.style.backgroundColor='var(--bg-tertiary)'"
                          title="Editar"
                        >
                          <Icon name="pencil" size={16} />
                          </button>
                        <button
                          onclick={`cambiarEstado(${prod.producto_id}, '${prod.estado === 'activo' ? 'inactivo' : 'activo'}')`}
                          class="p-2 rounded-lg transition-all"
                          style={prod.estado === 'activo'
                            ? 'background-color: rgba(239, 68, 68, 0.1); color: var(--accent-red);'
                            : 'background-color: rgba(16, 185, 129, 0.1); color: var(--accent-green);'}
                          onmouseenter={prod.estado === 'activo'
                            ? "this.style.backgroundColor='rgba(239, 68, 68, 0.2)'"
                            : "this.style.backgroundColor='rgba(16, 185, 129, 0.2)'"}
                          onmouseleave={prod.estado === 'activo'
                            ? "this.style.backgroundColor='rgba(239, 68, 68, 0.1)'"
                            : "this.style.backgroundColor='rgba(16, 185, 129, 0.1)'"}
                          title={prod.estado === 'activo' ? 'Desactivar' : 'Activar'}
                        >
                          <Icon name={prod.estado === 'activo' ? 'x-circle' : 'check-circle'} size={16} />
                        </button>
                        <button
                          onclick={`eliminarProducto(${prod.producto_id}, '${prod.nombre_producto.replace(/'/g, "\\'")}')`}
                          class="p-2 rounded-lg transition-all"
                          style="background-color: rgba(239, 68, 68, 0.1); color: var(--accent-red);"
                          onmouseenter="this.style.backgroundColor='var(--accent-red)'; this.style.color='white';"
                          onmouseleave="this.style.backgroundColor='rgba(239, 68, 68, 0.1)'; this.style.color='var(--accent-red)';"
                          title="Eliminar Permanentemente"
                        >
                          <Icon name="trash" size={16} />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Crear -->
  <div id="modal-crear" class="fixed inset-0 overflow-y-auto h-full w-full z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative rounded-xl shadow-2xl max-w-lg w-full animate-slideIn" style="background-color: var(--bg-secondary);">
        <div class="px-6 py-5 border-b" style="border-color: var(--border-primary);">
          <h3 class="text-xl font-bold flex items-center space-x-2" style="color: var(--text-primary);">
            <Icon name="plus" size={24} style="color: var(--accent-purple);" />
            <span>Nuevo Producto</span>
          </h3>
        </div>

        <form method="POST" action="/api/productos" class="p-6">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Nombre del producto <span style="color: var(--accent-red);">*</span>
              </label>
              <input
                type="text"
                name="nombre_producto"
                required
                placeholder="Ej: Laptop HP Pavilion, Mouse Logitech..."
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Categor√≠a <span style="color: var(--accent-red);">*</span>
              </label>
              <select
                name="categoria_id"
                required
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              >
                <option value="">Seleccionar categor√≠a</option>
                {categorias.map(cat => (
                  <option value={cat.categoria_id}>{cat.nombre_categoria}</option>
                ))}
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Precio <span style="color: var(--accent-red);">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-4 top-3 font-semibold" style="color: var(--text-secondary);">$</span>
                <input
                  type="number"
                  name="precio"
                  required
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                  class="w-full pl-8 pr-4 py-3 rounded-lg transition-all outline-none"
                  style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Descripci√≥n
              </label>
              <textarea
                name="descripcion"
                rows="4"
                placeholder="Describe las caracter√≠sticas del producto..."
                class="w-full px-4 py-3 rounded-lg transition-all outline-none resize-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              ></textarea>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button
              type="submit"
              class="btn-primary flex-1"
            >
              Crear Producto
            </button>
            <button
              type="button"
              onclick="document.getElementById('modal-crear').classList.add('hidden')"
              class="btn-secondary px-6"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Editar -->
  <div id="modal-editar" class="fixed inset-0 overflow-y-auto h-full w-full z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative rounded-xl shadow-2xl max-w-lg w-full animate-slideIn" style="background-color: var(--bg-secondary);">
        <div class="px-6 py-5 border-b" style="border-color: var(--border-primary);">
          <h3 class="text-xl font-bold flex items-center space-x-2" style="color: var(--text-primary);">
            <Icon name="pencil" size={24} style="color: var(--accent-blue);" />
            <span>Editar Producto</span>
          </h3>
        </div>

        <form method="POST" action="/api/productos" class="p-6">
          <input type="hidden" name="_method" value="PUT" />
          <input type="hidden" name="producto_id" id="edit-id" />

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Nombre del producto <span style="color: var(--accent-red);">*</span>
              </label>
              <input
                type="text"
                name="nombre_producto"
                id="edit-nombre"
                required
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Categor√≠a <span style="color: var(--accent-red);">*</span>
              </label>
              <select
                name="categoria_id"
                id="edit-categoria"
                required
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              >
                {categorias.map(cat => (
                  <option value={cat.categoria_id}>{cat.nombre_categoria}</option>
                ))}
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Precio <span style="color: var(--accent-red);">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-4 top-3 font-semibold" style="color: var(--text-secondary);">$</span>
                <input
                  type="number"
                  name="precio"
                  id="edit-precio"
                  required
                  min="0"
                  step="0.01"
                  class="w-full pl-8 pr-4 py-3 rounded-lg transition-all outline-none"
                  style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Descripci√≥n
              </label>
              <textarea
                name="descripcion"
                id="edit-descripcion"
                rows="4"
                class="w-full px-4 py-3 rounded-lg transition-all outline-none resize-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              ></textarea>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button
              type="submit"
              class="btn-primary flex-1"
            >
              Guardar Cambios
            </button>
            <button
              type="button"
              onclick="document.getElementById('modal-editar').classList.add('hidden')"
              class="btn-secondary px-6"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Ajustar Precios -->
  <div id="modal-ajustar-precios" class="fixed inset-0 overflow-y-auto h-full w-full z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative rounded-xl shadow-2xl max-w-lg w-full animate-slideIn" style="background-color: var(--bg-secondary);">
        <div class="px-6 py-5 border-b" style="border-color: var(--border-primary);">
          <h3 class="text-xl font-bold flex items-center space-x-2" style="color: var(--text-primary);">
            <Icon name="currency-dollar" size={24} style="color: var(--accent-yellow);" />
            <span>Ajustar Precios por Categor√≠a</span>
          </h3>
        </div>

        <div class="p-6">
          <div class="p-4 rounded-lg mb-6" style="background-color: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent-blue);">
            <p class="text-sm" style="color: var(--text-primary);">
              <strong>üí° Procedimiento Almacenado:</strong> Esta acci√≥n usa <code class="px-2 py-1 rounded font-mono" style="background-color: var(--bg-tertiary);">sp_ajustar_precios_categoria()</code>
            </p>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Categor√≠a <span style="color: var(--accent-red);">*</span>
              </label>
              <select
                id="ajuste-categoria"
                required
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              >
                <option value="">Seleccionar categor√≠a</option>
                {categorias.map(cat => (
                  <option value={cat.categoria_id}>{cat.nombre_categoria}</option>
                ))}
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Porcentaje de Ajuste <span style="color: var(--accent-red);">*</span>
              </label>
              <div class="relative">
                <input
                  type="number"
                  id="ajuste-porcentaje"
                  required
                  min="-100"
                  max="1000"
                  step="0.01"
                  placeholder="Ej: 10 para +10%, -15 para -15%"
                  class="w-full px-4 py-3 pr-12 rounded-lg transition-all outline-none"
                  style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
                />
                <span class="absolute right-4 top-3 font-semibold" style="color: var(--text-secondary);">%</span>
              </div>
              <p class="text-xs mt-2" style="color: var(--text-muted);">
                Valores positivos aumentan el precio, negativos lo reducen
              </p>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button
              type="button"
              onclick="ajustarPrecios()"
              class="flex-1"
              style="background-color: var(--accent-yellow); color: white; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s;"
              onmouseenter="this.style.backgroundColor='#d97706'"
              onmouseleave="this.style.backgroundColor='var(--accent-yellow)'"
            >
              Aplicar Ajuste
            </button>
            <button
              type="button"
              onclick="document.getElementById('modal-ajustar-precios').classList.add('hidden')"
              class="btn-secondary px-6"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
  </div>

  <script is:inline>
    function editarProducto(prod) {
      document.getElementById('edit-id').value = prod.producto_id;
      document.getElementById('edit-nombre').value = prod.nombre_producto;
      document.getElementById('edit-categoria').value = prod.categoria_id;
      document.getElementById('edit-precio').value = parseFloat(prod.precio);
      document.getElementById('edit-descripcion').value = prod.descripcion || '';
      document.getElementById('modal-editar').classList.remove('hidden');
    }

    async function cambiarEstado(id, nuevoEstado) {
      const mensaje = nuevoEstado === 'activo'
        ? '¬øActivar este producto?'
        : '¬øDesactivar este producto?';

      if (!confirm(mensaje)) return;

      try {
        const response = await fetch('/api/productos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            _method: 'PATCH',
            producto_id: id,
            estado: nuevoEstado
          })
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert('Error al cambiar el estado');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function eliminarProducto(productoId, nombreProducto) {
      if (!confirm(`‚ö†Ô∏è ELIMINAR PERMANENTEMENTE\n\n¬øEst√°s seguro de eliminar el producto "${nombreProducto}"?\n\nSe eliminar√° tambi√©n su stock asociado. Esta acci√≥n NO se puede deshacer y solo funciona si el producto NO est√° en pedidos.`)) {
        return;
      }

      if (!confirm(`Confirma nuevamente: ¬øEliminar "${nombreProducto}" de la base de datos?`)) {
        return;
      }

      try {
        const response = await fetch('/api/productos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            _method: 'DELETE',
            producto_id: productoId
          })
        });

        const url = new URL(response.url);
        const error = url.searchParams.get('error');

        if (error) {
          alert('‚ùå Error: ' + decodeURIComponent(error));
          location.href = '/productos';
        } else if (response.redirected || response.ok) {
          alert('‚úÖ Producto eliminado exitosamente');
          location.href = '/productos';
        } else {
          alert('Error al eliminar el producto');
        }
      } catch (error) {
        console.error('Error al eliminar producto:', error);
        alert('Error al eliminar el producto');
      }
    }

    async function ajustarPrecios() {
      const categoriaId = document.getElementById('ajuste-categoria').value;
      const porcentaje = document.getElementById('ajuste-porcentaje').value;

      if (!categoriaId || !porcentaje) {
        alert('Por favor completa todos los campos');
        return;
      }

      const mensaje = `¬øConfirmar ajuste de ${porcentaje > 0 ? '+' : ''}${porcentaje}% en los precios de esta categor√≠a?`;

      if (!confirm(mensaje)) return;

      try {
        const response = await fetch('/api/productos/ajustar-precios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            categoria_id: parseInt(categoriaId),
            porcentaje: parseFloat(porcentaje)
          })
        });

        const result = await response.json();

        if (response.ok) {
          alert(result.message);
          window.location.reload();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    const modals = ['modal-crear', 'modal-editar', 'modal-ajustar-precios'];
    modals.forEach(modalId => {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.add('hidden');
          }
        });
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        modals.forEach(modalId => {
          document.getElementById(modalId)?.classList.add('hidden');
        });
      }
    });
  </script>
</Layout>
