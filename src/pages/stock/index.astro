---
import Layout from '../../layouts/Layout.astro';
import Icon from '../../components/Icon.astro';
import { query } from '../../lib/db';

let stock: any[] = [];
let productos: any[] = [];
let error = '';

try {
  const resultStock = await query(`
    SELECT s.stock_id, s.producto_id, s.sku, s.precio_unitario,
           s.cantidad_en_stock, s.cantidad_reservada, s.estado, s.fecha_creacion,
           p.nombre_producto, c.nombre_categoria,
           (s.cantidad_en_stock - s.cantidad_reservada) as disponible
    FROM stock s
    JOIN productos p ON s.producto_id = p.producto_id
    JOIN categorias c ON p.categoria_id = c.categoria_id
    WHERE c.estado = 'activo' AND p.estado = 'activo'
    ORDER BY s.stock_id DESC
  `);
  stock = resultStock.rows;

  const resultProductos = await query(`
    SELECT p.producto_id, p.nombre_producto
    FROM productos p
    INNER JOIN categorias c ON p.categoria_id = c.categoria_id
    WHERE p.estado = 'activo' AND c.estado = 'activo'
    ORDER BY p.nombre_producto
  `);
  productos = resultProductos.rows;
} catch (err) {
  error = 'Error al cargar stock: ' + (err as Error).message;
  console.error(err);
}

const activos = stock.filter(s => s.estado === 'activo').length;
const inactivos = stock.filter(s => s.estado === 'inactivo').length;
const totalStock = stock.reduce((sum, s) => sum + parseInt(s.cantidad_en_stock || 0), 0);
const stockReservado = stock.reduce((sum, s) => sum + parseInt(s.cantidad_reservada || 0), 0);
---

<Layout title="Stock / Inventario">
  <!-- Header -->
  <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold mb-1" style="color: var(--text-primary);">Gesti√≥n de Inventario</h1>
      <p class="text-sm" style="color: var(--text-secondary);">Control de SKUs, stock disponible y reabastecimientos</p>
    </div>
    <button
      onclick="document.getElementById('modal-crear').classList.remove('hidden')"
      class="btn-primary inline-flex items-center space-x-2"
    >
      <Icon name="plus" size={18} />
      <span>Nuevo SKU</span>
    </button>
  </div>

  {error && (
    <div class="mb-6 p-4 rounded-lg flex items-center space-x-3"
         style="background-color: var(--bg-secondary); border-left: 4px solid var(--accent-red);">
      <Icon name="exclamation-triangle" size={20} style="color: var(--accent-red);" />
      <p style="color: var(--text-primary);">{error}</p>
    </div>
  )}

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm mb-1" style="color: var(--text-secondary);">Total SKUs</p>
          <p class="text-2xl font-bold" style="color: var(--text-primary);">{stock.length}</p>
        </div>
        <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: var(--accent-blue);">
          <Icon name="cube" size={24} class="text-white" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm mb-1" style="color: var(--text-secondary);">SKUs Activos</p>
          <p class="text-2xl font-bold" style="color: var(--accent-green);">{activos}</p>
        </div>
        <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: var(--accent-green);">
          <Icon name="check-circle" size={24} class="text-white" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm mb-1" style="color: var(--text-secondary);">Stock Total</p>
          <p class="text-2xl font-bold" style="color: var(--accent-purple);">{totalStock}</p>
        </div>
        <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: var(--accent-purple);">
          <Icon name="rectangle-stack" size={24} class="text-white" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm mb-1" style="color: var(--text-secondary);">Reservado</p>
          <p class="text-2xl font-bold" style="color: var(--accent-yellow);">{stockReservado}</p>
        </div>
        <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: var(--accent-yellow);">
          <Icon name="clock" size={24} class="text-white" />
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de Stock -->
  <div class="card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead>
          <tr style="border-bottom: 1px solid var(--border-primary);">
            <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">SKU</th>
            <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">Producto</th>
            <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">Categor√≠a</th>
            <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">Precio</th>
            <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">En Stock</th>
            <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">Reservado</th>
            <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">Disponible</th>
            <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">Estado</th>
            <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider" style="color: var(--text-secondary);">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {stock.length === 0 ? (
            <tr>
              <td colspan="9" class="px-6 py-12 text-center">
                <div class="flex flex-col items-center justify-center">
                  <Icon name="cube" size={48} style="color: var(--text-muted);" class="mb-4" />
                  <p class="text-base font-medium mb-1" style="color: var(--text-secondary);">No hay SKUs registrados</p>
                  <p class="text-sm" style="color: var(--text-muted);">Crea tu primer SKU para comenzar</p>
                </div>
              </td>
            </tr>
          ) : (
            stock.map((item) => (
              <tr class="border-b transition-colors"
                  style="border-color: var(--border-primary);"
                  onmouseenter="this.style.backgroundColor='var(--bg-tertiary)'"
                  onmouseleave="this.style.backgroundColor='transparent'">
                <td class="px-6 py-4">
                  <span class="font-mono text-sm font-semibold" style="color: var(--text-primary);">{item.sku}</span>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm font-medium" style="color: var(--text-primary);">{item.nombre_producto}</div>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium"
                        style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);">
                    {item.nombre_categoria}
                  </span>
                </td>
                <td class="px-6 py-4 text-right">
                  <span class="text-sm font-bold" style="color: var(--accent-green);">${parseFloat(item.precio_unitario).toFixed(2)}</span>
                </td>
                <td class="px-6 py-4 text-center">
                  <span class={`inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-semibold`}
                        style={item.cantidad_en_stock > 50
                          ? 'background-color: rgba(16, 185, 129, 0.1); color: var(--accent-green); border: 1px solid var(--accent-green);'
                          : item.cantidad_en_stock > 20
                            ? 'background-color: rgba(245, 158, 11, 0.1); color: var(--accent-yellow); border: 1px solid var(--accent-yellow);'
                            : 'background-color: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red);'}>
                    {item.cantidad_en_stock}
                  </span>
                </td>
                <td class="px-6 py-4 text-center">
                  <span class="text-sm font-medium" style="color: var(--text-secondary);">{item.cantidad_reservada}</span>
                </td>
                <td class="px-6 py-4 text-center">
                  <span class="text-sm font-bold" style="color: var(--accent-blue);">{item.disponible}</span>
                </td>
                <td class="px-6 py-4 text-center">
                  <span class={`inline-flex items-center space-x-1 px-2.5 py-0.5 rounded-md text-xs font-medium`}
                        style={item.estado === 'activo'
                          ? 'background-color: rgba(16, 185, 129, 0.1); color: var(--accent-green); border: 1px solid var(--accent-green);'
                          : 'background-color: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red);'}>
                    <Icon name={item.estado === 'activo' ? 'check-circle' : 'x-circle'} size={12} />
                    <span>{item.estado === 'activo' ? 'Activo' : 'Inactivo'}</span>
                  </span>
                </td>
                <td class="px-6 py-4 text-right">
                  <div class="flex justify-end gap-2">
                    <button
                      onclick={`editar(${item.stock_id}, '${item.sku}', ${item.producto_id}, ${item.precio_unitario}, ${item.cantidad_en_stock})`}
                      class="p-2 rounded-lg transition-all"
                      style="background-color: var(--bg-tertiary); color: var(--accent-blue);"
                      onmouseenter="this.style.backgroundColor='var(--bg-hover)'"
                      onmouseleave="this.style.backgroundColor='var(--bg-tertiary)'"
                      title="Editar"
                    >
                      <Icon name="pencil" size={16} />
                    </button>
                    <button
                      onclick={`reabastecer(${item.stock_id}, '${item.sku}', '${item.nombre_producto.replace(/'/g, "\\'")}', ${item.precio_unitario})`}
                      class="p-2 rounded-lg transition-all"
                      style="background-color: rgba(16, 185, 129, 0.1); color: var(--accent-green);"
                      onmouseenter="this.style.backgroundColor='rgba(16, 185, 129, 0.2)'"
                      onmouseleave="this.style.backgroundColor='rgba(16, 185, 129, 0.1)'"
                      title="Reabastecer"
                    >
                      <Icon name="arrow-path" size={16} />
                    </button>
                    <button
                      onclick={`cambiarEstado(${item.stock_id}, '${item.estado === 'activo' ? 'inactivo' : 'activo'}')`}
                      class="p-2 rounded-lg transition-all"
                      style={item.estado === 'activo'
                        ? 'background-color: rgba(239, 68, 68, 0.1); color: var(--accent-red);'
                        : 'background-color: rgba(16, 185, 129, 0.1); color: var(--accent-green);'}
                      title={item.estado === 'activo' ? 'Desactivar' : 'Activar'}
                    >
                      <Icon name={item.estado === 'activo' ? 'x-circle' : 'check-circle'} size={16} />
                    </button>
                    <button
                      onclick={`eliminarStock(${item.stock_id}, '${item.sku}')`}
                      class="p-2 rounded-lg transition-all"
                      style="background-color: rgba(239, 68, 68, 0.1); color: var(--accent-red);"
                      onmouseenter="this.style.backgroundColor='var(--accent-red)'; this.style.color='white';"
                      onmouseleave="this.style.backgroundColor='rgba(239, 68, 68, 0.1)'; this.style.color='var(--accent-red)';"
                      title="Eliminar Permanentemente"
                    >
                      <Icon name="trash" size={16} />
                    </button>
                  </div>
                </td>
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal Crear SKU -->
  <div id="modal-crear" class="fixed inset-0 overflow-y-auto h-full w-full z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative rounded-xl shadow-2xl max-w-lg w-full animate-slideIn" style="background-color: var(--bg-secondary);">
        <div class="px-6 py-5 border-b" style="border-color: var(--border-primary);">
          <h3 class="text-xl font-bold flex items-center space-x-2" style="color: var(--text-primary);">
            <Icon name="plus" size={24} style="color: var(--accent-green);" />
            <span>Crear Nuevo SKU</span>
          </h3>
        </div>

        <form action="/api/stock" method="POST" class="p-6">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Producto <span style="color: var(--accent-red);">*</span>
              </label>
              <select
                name="producto_id"
                required
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
            >
              <option value="">Selecciona un producto</option>
              {productos.map(p => (
                <option value={p.producto_id}>{p.nombre_producto}</option>
              ))}
            </select>
          </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                SKU <span style="color: var(--accent-red);">*</span>
              </label>
              <input
                type="text"
                name="sku"
                required
                placeholder="Ej: PROD-001-XL"
                class="w-full px-4 py-3 rounded-lg transition-all outline-none font-mono"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              />
          </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Precio Unitario <span style="color: var(--accent-red);">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-4 top-3 font-semibold" style="color: var(--text-secondary);">$</span>
                <input
                  type="number"
                  name="precio_unitario"
                  required
                  min="0"
                  step="0.01"
                  class="w-full pl-8 pr-4 py-3 rounded-lg transition-all outline-none"
                  style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
                />
              </div>
          </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Cantidad Inicial <span style="color: var(--accent-red);">*</span>
              </label>
              <input
                type="number"
                name="cantidad_en_stock"
                required
                min="0"
                value="0"
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              />
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button type="submit" class="btn-success flex-1">
              Crear SKU
            </button>
            <button
              type="button"
              onclick="document.getElementById('modal-crear').classList.add('hidden')"
              class="btn-secondary px-6"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Editar SKU -->
  <div id="modal-editar" class="fixed inset-0 overflow-y-auto h-full w-full z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative rounded-xl shadow-2xl max-w-lg w-full animate-slideIn" style="background-color: var(--bg-secondary);">
        <div class="px-6 py-5 border-b" style="border-color: var(--border-primary);">
          <h3 class="text-xl font-bold flex items-center space-x-2" style="color: var(--text-primary);">
            <Icon name="pencil" size={24} style="color: var(--accent-blue);" />
            <span>Editar SKU</span>
          </h3>
        </div>

        <form action="/api/stock" method="POST" class="p-6">
          <input type="hidden" name="_method" value="PUT" />
          <input type="hidden" name="stock_id" id="edit-stock-id" />

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Producto <span style="color: var(--accent-red);">*</span>
              </label>
              <select
                name="producto_id"
                id="edit-producto"
                required
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              >
                {productos.map(p => (
                  <option value={p.producto_id}>{p.nombre_producto}</option>
                ))}
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                SKU <span style="color: var(--accent-red);">*</span>
              </label>
              <input
                type="text"
                name="sku"
                id="edit-sku"
                required
                class="w-full px-4 py-3 rounded-lg transition-all outline-none font-mono"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Precio Unitario <span style="color: var(--accent-red);">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-4 top-3 font-semibold" style="color: var(--text-secondary);">$</span>
                <input
                  type="number"
                name="precio_unitario"
                id="edit-precio"
                required
                min="0"
                step="0.01"
                class="w-full pl-8 pr-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              />
              </div>
            </div>

            <div class="p-4 rounded-lg" style="background-color: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent-blue);">
              <p class="text-sm" style="color: var(--text-primary);">
                <Icon name="information-circle" size={16} class="inline mr-1" style="color: var(--accent-blue);" />
                Para modificar la cantidad en stock, usa el bot√≥n <strong>"Reabastecer Stock"</strong>
              </p>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button type="submit" class="btn-primary flex-1">
              Guardar Cambios
            </button>
            <button
              type="button"
              onclick="document.getElementById('modal-editar').classList.add('hidden')"
              class="btn-secondary px-6"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Reabastecer (Stored Procedure) -->
  <div id="modal-reabastecer" class="fixed inset-0 overflow-y-auto h-full w-full z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="relative rounded-xl shadow-2xl max-w-lg w-full animate-slideIn" style="background-color: var(--bg-secondary);">
        <div class="px-6 py-5 border-b" style="border-color: var(--border-primary);">
          <h3 class="text-xl font-bold flex items-center space-x-2" style="color: var(--text-primary);">
            <Icon name="arrow-path" size={24} style="color: var(--accent-green);" />
            <span>Reabastecer Stock</span>
          </h3>
        </div>

        <form action="/api/stock/reabastecer" method="POST" class="p-6">
          <input type="hidden" name="stock_id" id="reab-stock-id" />

          <div class="p-4 rounded-lg mb-5" style="background-color: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent-blue);">
            <p class="text-sm" style="color: var(--text-primary);">
              <strong>üí° Procedimiento Almacenado:</strong> Esta acci√≥n usa <code class="px-2 py-1 rounded font-mono" style="background-color: var(--bg-tertiary);">sp_reabastecer_stock()</code>
            </p>
          </div>

          <div class="p-4 rounded-lg mb-5" style="background-color: var(--bg-tertiary);">
            <p class="text-sm mb-1" style="color: var(--text-secondary);">SKU: <span id="reab-sku" class="font-mono font-bold" style="color: var(--text-primary);"></span></p>
            <p class="text-sm" style="color: var(--text-secondary);">Producto: <span id="reab-producto" class="font-semibold" style="color: var(--text-primary);"></span></p>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Cantidad a Agregar <span style="color: var(--accent-red);">*</span>
              </label>
              <input
                type="number"
                name="cantidad"
                required
                min="1"
                placeholder="Ej: 100"
                class="w-full px-4 py-3 rounded-lg transition-all outline-none"
                style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2" style="color: var(--text-primary);">
                Nuevo Costo Unitario (Opcional)
              </label>
              <div class="relative">
                <span class="absolute left-4 top-3 font-semibold" style="color: var(--text-secondary);">$</span>
                <input
                  type="number"
                  name="costo_unitario"
                  id="reab-precio"
                  min="0"
                  step="0.01"
                  placeholder="Dejar vac√≠o para mantener precio actual"
                  class="w-full pl-8 pr-4 py-3 rounded-lg transition-all outline-none"
                  style="background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);"
                />
              </div>
              <p class="mt-2 text-xs" style="color: var(--text-muted);">Si especificas un costo, se actualizar√° el precio del SKU</p>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button type="submit" class="btn-success flex-1">
              Reabastecer
            </button>
            <button
              type="button"
              onclick="document.getElementById('modal-reabastecer').classList.add('hidden')"
              class="btn-secondary px-6"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script is:inline>
    window.editar = function(stock_id, sku, producto_id, precio, cantidad) {
      document.getElementById('edit-stock-id').value = stock_id;
      document.getElementById('edit-sku').value = sku;
      document.getElementById('edit-producto').value = producto_id;
      document.getElementById('edit-precio').value = precio;
      document.getElementById('modal-editar').classList.remove('hidden');
    }

    window.reabastecer = function(stock_id, sku, producto, precioActual) {
      document.getElementById('reab-stock-id').value = stock_id;
      document.getElementById('reab-sku').textContent = sku;
      document.getElementById('reab-producto').textContent = producto;
      document.getElementById('reab-precio').placeholder = `Precio actual: $${parseFloat(precioActual).toFixed(2)}`;
      document.getElementById('modal-reabastecer').classList.remove('hidden');
    }

    window.cambiarEstado = async function(stock_id, nuevoEstado) {
      if (!confirm(`¬øEst√°s seguro de ${nuevoEstado === 'activo' ? 'activar' : 'desactivar'} este SKU?`)) return;

      try {
        const formData = new FormData();
        formData.append('_method', 'PATCH');
        formData.append('stock_id', stock_id);
        formData.append('estado', nuevoEstado);

        const response = await fetch('/api/stock', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          location.reload();
        } else {
          alert('Error al cambiar el estado');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cambiar el estado');
      }
    }

    window.eliminarStock = async function(stockId, sku) {
      if (!confirm(`‚ö†Ô∏è ELIMINAR PERMANENTEMENTE\n\n¬øEst√°s seguro de eliminar el SKU "${sku}"?\n\nEsta acci√≥n NO se puede deshacer y solo funciona si el stock NO est√° reservado ni en pedidos.`)) {
        return;
      }

      if (!confirm(`Confirma nuevamente: ¬øEliminar SKU "${sku}" de la base de datos?`)) {
        return;
      }

      try {
        const response = await fetch('/api/stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            _method: 'DELETE',
            stock_id: stockId
          })
        });

        const url = new URL(response.url);
        const error = url.searchParams.get('error');

        if (error) {
          alert('‚ùå Error: ' + decodeURIComponent(error));
          location.href = '/stock';
        } else if (response.redirected || response.ok) {
          alert('‚úÖ Stock eliminado exitosamente');
          location.href = '/stock';
        } else {
          alert('Error al eliminar el stock');
        }
      } catch (error) {
        console.error('Error al eliminar stock:', error);
        alert('Error al eliminar el stock');
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('modal-crear').classList.add('hidden');
        document.getElementById('modal-editar').classList.add('hidden');
        document.getElementById('modal-reabastecer').classList.add('hidden');
      }
    });

    ['modal-crear', 'modal-editar', 'modal-reabastecer'].forEach(modalId => {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target.id === modalId) {
            e.target.classList.add('hidden');
          }
        });
      }
    });
  </script>
</Layout>
