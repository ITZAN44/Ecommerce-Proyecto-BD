---
import Layout from '../../layouts/Layout.astro';
import { query } from '../../lib/db';
import type { Cliente } from '../../lib/types';

let clientes: Cliente[] = [];
let error = '';

try {
  const result = await query(`
    SELECT cliente_id, nombre, apellido, email, estado, fecha_creacion
    FROM clientes
    ORDER BY cliente_id DESC
  `);
  clientes = result.rows;
} catch (err) {
  error = 'Error al cargar clientes: ' + (err as Error).message;
  console.error(err);
}

const activos = clientes.filter(c => c.estado === 'activo').length;
const inactivos = clientes.filter(c => c.estado === 'inactivo').length;
const suspendidos = clientes.filter(c => c.estado === 'suspendido').length;
---

<Layout title="Clientes">
  <div class="min-h-screen bg-gradient-to-br from-slate-50 via-indigo-50 to-slate-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- Header -->
      <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-blue-600 bg-clip-text text-transparent flex items-center gap-3">
              <span class="text-4xl">üë•</span> Clientes
            </h1>
            <p class="mt-2 text-slate-600">Gestiona la informaci√≥n de tus clientes</p>
          </div>
          <button
            onclick="document.getElementById('modal-crear').classList.remove('hidden')"
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Nuevo Cliente
          </button>
        </div>
      </div>

      {error && (
        <div class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <p class="text-red-700 font-medium">{error}</p>
          </div>
        </div>
      )}

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-indigo-600 to-blue-600 rounded-2xl p-6 text-white shadow-xl transform hover:scale-105 transition-all duration-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-indigo-100 text-sm font-medium">Total Clientes</p>
              <p class="text-4xl font-bold mt-2">{clientes.length}</p>
            </div>
            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-2xl p-6 text-white shadow-xl transform hover:scale-105 transition-all duration-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-green-100 text-sm font-medium">Activos</p>
              <p class="text-4xl font-bold mt-2">{activos}</p>
            </div>
            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-slate-600 to-slate-700 rounded-2xl p-6 text-white shadow-xl transform hover:scale-105 transition-all duration-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-slate-200 text-sm font-medium">Inactivos</p>
              <p class="text-4xl font-bold mt-2">{inactivos}</p>
            </div>
            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-orange-600 to-red-600 rounded-2xl p-6 text-white shadow-xl transform hover:scale-105 transition-all duration-200">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-orange-100 text-sm font-medium">Suspendidos</p>
              <p class="text-4xl font-bold mt-2">{suspendidos}</p>
            </div>
            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Clientes -->
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-gradient-to-r from-slate-50 to-slate-100">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider">Cliente</th>
                <th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider">Email</th>
                <th class="px-6 py-4 text-center text-xs font-bold text-slate-700 uppercase tracking-wider">Estado</th>
                <th class="px-6 py-4 text-center text-xs font-bold text-slate-700 uppercase tracking-wider">Fecha Registro</th>
                <th class="px-6 py-4 text-right text-xs font-bold text-slate-700 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
              {clientes.map((cliente) => (
                <tr class="hover:bg-slate-50 transition-colors duration-150">
                  <td class="px-6 py-4">
                    <div class="flex items-center">
                      <div class="shrink-0 h-12 w-12 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-full flex items-center justify-center shadow-md">
                        <span class="text-white font-bold text-lg">{cliente.nombre.charAt(0)}{cliente.apellido.charAt(0)}</span>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-bold text-slate-900">{cliente.nombre} {cliente.apellido}</div>
                        <div class="text-xs text-slate-500">ID: {cliente.cliente_id}</div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm text-slate-700 flex items-center gap-2">
                      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                      </svg>
                      {cliente.email}
                    </div>
                  </td>
                  <td class="px-6 py-4 text-center">
                    <span class={`inline-flex px-3 py-1 text-xs font-bold rounded-full ${
                      cliente.estado === 'activo' ? 'bg-green-100 text-green-800' :
                      cliente.estado === 'suspendido' ? 'bg-red-100 text-red-800' :
                      'bg-slate-100 text-slate-800'
                    }`}>
                      {cliente.estado}
                    </span>
                  </td>
                  <td class="px-6 py-4 text-center text-sm text-slate-600">
                    {new Date(cliente.fecha_creacion).toLocaleDateString('es-ES', {
                      day: '2-digit',
                      month: 'short',
                      year: 'numeric'
                    })}
                  </td>
                  <td class="px-6 py-4 text-right">
                    <div class="flex justify-end gap-2">
                      <button
                        onclick={`verDirecciones(${cliente.cliente_id}, '${cliente.nombre}', '${cliente.apellido}')`}
                        class="text-cyan-600 hover:text-cyan-800 font-semibold hover:bg-cyan-50 p-2 rounded-lg transition-colors"
                        title="Ver Direcciones"
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                      </button>
                      <button
                        onclick={`verificarPedidos(${cliente.cliente_id})`}
                        class="text-blue-600 hover:text-blue-800 font-semibold hover:bg-blue-50 p-2 rounded-lg transition-colors"
                        title="Verificar Pedidos"
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                      </button>
                      <button
                        onclick={`calcularPuntos(${cliente.cliente_id})`}
                        class="text-purple-600 hover:text-purple-800 font-semibold hover:bg-purple-50 p-2 rounded-lg transition-colors"
                        title="Puntos de Fidelidad"
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                      </button>
                      <button
                        onclick={`editar(${JSON.stringify(cliente)})`}
                        class="text-amber-600 hover:text-amber-800 font-semibold hover:bg-amber-50 p-2 rounded-lg transition-colors"
                        title="Editar"
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                      </button>
                      <button
                        onclick={`cambiarEstado(${cliente.cliente_id}, ${JSON.stringify(cliente.estado)})`}
                        class={`font-semibold p-2 rounded-lg transition-colors ${
                          cliente.estado === 'activo' 
                            ? 'text-red-600 hover:text-red-800 hover:bg-red-50'
                            : cliente.estado === 'suspendido'
                            ? 'text-green-600 hover:text-green-800 hover:bg-green-50'
                            : 'text-green-600 hover:text-green-800 hover:bg-green-50'
                        }`}
                        title={cliente.estado === 'activo' ? 'Suspender/Inactivar' : 'Activar'}
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          {cliente.estado === 'activo' ? (
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                          ) : (
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                          )}
                        </svg>
                      </button>
                      <button
                        onclick={`eliminar Cliente(${cliente.cliente_id}, '${cliente.nombre} ${cliente.apellido}')`}
                        class="text-rose-600 hover:text-rose-800 font-semibold hover:bg-rose-50 p-2 rounded-lg transition-colors"
                        title="Eliminar Permanentemente"
                      >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Crear Cliente -->
  <div id="modal-crear" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full animate-slideIn">
      <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-t-2xl px-6 py-5">
        <h3 class="text-2xl font-bold text-white flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Nuevo Cliente
        </h3>
      </div>
      
      <form action="/api/clientes" method="POST" class="p-6">
        <div class="space-y-5">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                Nombre <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="nombre"
                required
                placeholder="Juan"
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 outline-none"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                Apellido <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="apellido"
                required
                placeholder="P√©rez"
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 outline-none"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              name="email"
              required
              placeholder="cliente@ejemplo.com"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 outline-none"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Contrase√±a <span class="text-red-500">*</span>
            </label>
            <input
              type="password"
              name="contrasena"
              required
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              minlength="6"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 outline-none"
            />
            <p class="mt-1 text-xs text-slate-500">M√≠nimo 6 caracteres</p>
          </div>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button
            type="submit"
            class="flex-1 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
          >
            Crear Cliente
          </button>
          <button
            type="button"
            onclick="document.getElementById('modal-crear').classList.add('hidden')"
            class="px-6 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl transition-all duration-200"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Editar Cliente -->
  <div id="modal-editar" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full animate-slideIn">
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-t-2xl px-6 py-5">
        <h3 class="text-2xl font-bold text-white flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          Editar Cliente
        </h3>
      </div>
      
      <form action="/api/clientes" method="POST" class="p-6">
        <input type="hidden" name="_method" value="PUT" />
        <input type="hidden" name="cliente_id" id="edit-id" />
        
        <div class="space-y-5">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                Nombre <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="nombre"
                id="edit-nombre"
                required
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 outline-none"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                Apellido <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="apellido"
                id="edit-apellido"
                required
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 outline-none"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              name="email"
              id="edit-email"
              required
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 outline-none"
            />
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Nueva Contrase√±a (Opcional)
            </label>
            <input
              type="password"
              name="contrasena"
              id="edit-contrasena"
              placeholder="Dejar vac√≠o para mantener la actual"
              minlength="6"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 outline-none"
            />
            <p class="mt-1 text-xs text-slate-500">Solo llenar si deseas cambiar la contrase√±a</p>
          </div>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button
            type="submit"
            class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
          >
            Guardar Cambios
          </button>
          <button
            type="button"
            onclick="document.getElementById('modal-editar').classList.add('hidden')"
            class="px-6 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl transition-all duration-200"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Ver Direcciones del Cliente -->
  <div id="modal-direcciones" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-3xl w-full animate-slideIn max-h-[90vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-cyan-600 to-blue-600 rounded-t-2xl px-6 py-5 sticky top-0 z-10">
        <h3 class="text-2xl font-bold text-white flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          Direcciones de <span id="modal-direcciones-cliente-nombre"></span>
        </h3>
      </div>
      
      <div class="p-6">
        <input type="hidden" id="modal-direcciones-cliente-id" />
        
        <!-- Direcciones existentes -->
        <div class="mb-6">
          <h4 class="text-lg font-bold text-slate-900 mb-4">Direcciones Registradas</h4>
          <div id="lista-direcciones" class="space-y-3">
            <!-- Se llenar√° din√°micamente con JavaScript -->
          </div>
        </div>

        <!-- Formulario agregar nueva direcci√≥n -->
        <div class="border-t-2 border-slate-200 pt-6">
          <h4 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Agregar Nueva Direcci√≥n
          </h4>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                Direcci√≥n <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="nueva-direccion"
                placeholder="Calle Principal #123, Edificio XYZ"
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 outline-none"
              />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">
                  Ciudad <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="nueva-ciudad"
                  placeholder="Ciudad"
                  class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 outline-none"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">
                  C√≥digo Postal <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="nueva-cp"
                  placeholder="12345"
                  class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 outline-none"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                Pa√≠s <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="nueva-pais"
                placeholder="Pa√≠s"
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all duration-200 outline-none"
              />
            </div>

            <button
              type="button"
              onclick="crearDireccionDesdeModal()"
              class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
            >
              Agregar Direcci√≥n
            </button>
          </div>
        </div>

        <div class="mt-6">
          <button
            type="button"
            onclick="document.getElementById('modal-direcciones').classList.add('hidden')"
            class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl transition-all duration-200"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar Direcci√≥n -->
  <div id="modal-editar-direccion" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm overflow-y-auto h-full w-full z-[60] flex items-center justify-center p-4">
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full animate-slideIn">
      <div class="bg-gradient-to-r from-amber-600 to-orange-600 rounded-t-2xl px-6 py-5">
        <h3 class="text-2xl font-bold text-white flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          Editar Direcci√≥n
        </h3>
      </div>
      
      <div class="p-6">
        <input type="hidden" id="edit-dir-id" />
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Direcci√≥n <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="edit-dir-direccion"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 outline-none"
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                Ciudad <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="edit-dir-ciudad"
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 outline-none"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-2">
                C√≥digo Postal <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="edit-dir-cp"
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 outline-none"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Pa√≠s <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="edit-dir-pais"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200 outline-none"
            />
          </div>

          <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
            <p class="text-sm text-blue-800">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Al actualizar, se registrar√° autom√°ticamente la fecha de modificaci√≥n
            </p>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button
            type="button"
            onclick="actualizarDireccion()"
            class="flex-1 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
          >
            Guardar Cambios
          </button>
          <button
            type="button"
            onclick="document.getElementById('modal-editar-direccion').classList.add('hidden')"
            class="px-6 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl transition-all duration-200"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    function editar(cliente) {
      document.getElementById('edit-id').value = cliente.cliente_id;
      document.getElementById('edit-nombre').value = cliente.nombre;
      document.getElementById('edit-apellido').value = cliente.apellido;
      document.getElementById('edit-email').value = cliente.email;
      document.getElementById('edit-contrasena').value = '';
      document.getElementById('modal-editar').classList.remove('hidden');
    }

    async function verificarPedidos(clienteId) {
      try {
        const response = await fetch(`/api/clientes/tiene-pedidos?cliente_id=${clienteId}`);
        const data = await response.json();
        
        const icono = data.tiene_pedidos ? '‚úÖ' : '‚ÑπÔ∏è';
        alert(`${icono} ${data.mensaje}`);
      } catch (error) {
        console.error('Error al verificar pedidos:', error);
        alert('Error al verificar pedidos del cliente');
      }
    }

    async function calcularPuntos(clienteId) {
      try {
        const response = await fetch(`/api/clientes/puntos-fidelidad?cliente_id=${clienteId}`);
        const data = await response.json();
        
        alert(`‚≠ê ${data.nombre_completo}\n\n${data.mensaje}`);
      } catch (error) {
        console.error('Error al calcular puntos:', error);
        alert('Error al calcular puntos de fidelidad');
      }
    }

    async function cambiarEstado(clienteId, estadoActual) {
      let opciones = '';
      if (estadoActual === 'activo') {
        opciones = 'Selecciona el nuevo estado:\n\n1. Inactivo\n2. Suspendido\n\nEscribe 1 o 2:';
      } else {
        opciones = '¬øActivar este cliente?';
      }

      let nuevoEstado;
      if (estadoActual === 'activo') {
        const respuesta = prompt(opciones);
        if (!respuesta) return;
        nuevoEstado = respuesta === '1' ? 'inactivo' : respuesta === '2' ? 'suspendido' : null;
        if (!nuevoEstado) {
          alert('Opci√≥n inv√°lida');
          return;
        }
      } else {
        if (!confirm(opciones)) return;
        nuevoEstado = 'activo';
      }
      
      try {
        const formData = new FormData();
        formData.append('_method', 'PATCH');
        formData.append('cliente_id', clienteId);
        formData.append('estado', nuevoEstado);
        
        const response = await fetch('/api/clientes', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          location.reload();
        } else {
          alert('Error al cambiar el estado');
        }
      } catch (error) {
        console.error('Error al cambiar estado:', error);
        alert('Error al cambiar el estado');
      }
    }

    async function eliminarCliente(clienteId, nombreCompleto) {
      // Confirmaci√≥n doble para eliminaci√≥n permanente
      if (!confirm(`‚ö†Ô∏è ELIMINAR PERMANENTEMENTE\n\n¬øEst√°s seguro de eliminar al cliente "${nombreCompleto}"?\n\nEsta acci√≥n NO se puede deshacer y solo funciona si el cliente NO tiene pedidos asociados.`)) {
        return;
      }

      if (!confirm(`Confirma nuevamente: ¬øEliminar a "${nombreCompleto}" de la base de datos?`)) {
        return;
      }

      try {
        const formData = new FormData();
        formData.append('_method', 'DELETE');
        formData.append('cliente_id', clienteId);
        
        const response = await fetch('/api/clientes', {
          method: 'POST',
          body: formData
        });

        // Verificar si hubo redirecci√≥n con error
        const url = new URL(response.url);
        const error = url.searchParams.get('error');
        
        if (error) {
          alert('‚ùå Error: ' + decodeURIComponent(error));
          location.href = '/clientes';
        } else if (response.redirected || response.ok) {
          alert('‚úÖ Cliente eliminado exitosamente');
          location.href = '/clientes';
        } else {
          alert('Error al eliminar el cliente');
        }
      } catch (error) {
        console.error('Error al eliminar cliente:', error);
        alert('Error al eliminar el cliente');
      }
    }

    async function verDirecciones(clienteId, nombre, apellido) {
      try {
        const response = await fetch(`/api/clientes/direcciones?cliente_id=${clienteId}`);
        const direcciones = await response.json();
        
        // Llenar modal con direcciones
        document.getElementById('modal-direcciones-cliente-nombre').textContent = `${nombre} ${apellido}`;
        document.getElementById('modal-direcciones-cliente-id').value = clienteId;
        
        const contenedor = document.getElementById('lista-direcciones');
        if (direcciones.length === 0) {
          contenedor.innerHTML = `
            <div class="text-center py-8 text-slate-500">
              <svg class="w-16 h-16 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <p class="font-medium">Este cliente no tiene direcciones registradas</p>
            </div>
          `;
        } else {
          contenedor.innerHTML = direcciones.map((dir, index) => {
            const fechaCreacion = new Date(dir.fecha_creacion).toLocaleDateString('es-ES', {
              day: '2-digit',
              month: 'short',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            return `
            <div class="border-2 border-slate-200 rounded-xl p-4 hover:border-cyan-300 transition-colors ${dir.estado === 'inactivo' ? 'opacity-50' : ''}" data-direccion-index="${index}">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-cyan-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="font-bold text-slate-900">${dir.direccion_linea_1}</span>
                  </div>
                  <div class="text-sm text-slate-600 space-y-1 ml-7">
                    <p><span class="font-semibold">Ciudad:</span> ${dir.ciudad}</p>
                    <p><span class="font-semibold">CP:</span> ${dir.codigo_postal}</p>
                    <p><span class="font-semibold">Pa√≠s:</span> ${dir.pais}</p>
                    <p class="text-xs text-slate-500 mt-2">
                      <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                      Registrado: ${fechaCreacion}
                    </p>
                  </div>
                </div>
                <div class="flex flex-col gap-2 items-end">
                  <span class="inline-flex px-3 py-1 text-xs font-bold rounded-full ${dir.estado === 'activo' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-800'}">
                    ${dir.estado}
                  </span>
                  <button
                    onclick="editarDireccionPorIndice(${index})"
                    class="text-amber-600 hover:text-amber-800 font-semibold hover:bg-amber-50 p-2 rounded-lg transition-colors"
                    title="Editar direcci√≥n"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          `;
          }).join('');
          
          // Guardar direcciones en variable global para acceso desde botones
          window.direccionesActuales = direcciones;
        }
        
        document.getElementById('modal-direcciones').classList.remove('hidden');
      } catch (error) {
        console.error('Error al cargar direcciones:', error);
        alert('Error al cargar las direcciones del cliente');
      }
    }

    async function crearDireccionDesdeModal() {
      const clienteId = document.getElementById('modal-direcciones-cliente-id').value;
      const direccion = document.getElementById('nueva-direccion').value;
      const ciudad = document.getElementById('nueva-ciudad').value;
      const cp = document.getElementById('nueva-cp').value;
      const pais = document.getElementById('nueva-pais').value;

      if (!direccion || !ciudad || !cp || !pais) {
        alert('Por favor completa todos los campos');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('cliente_id', clienteId);
        formData.append('direccion_linea_1', direccion);
        formData.append('ciudad', ciudad);
        formData.append('codigo_postal', cp);
        formData.append('pais', pais);

        const response = await fetch('/api/direcciones', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          // Limpiar formulario
          document.getElementById('nueva-direccion').value = '';
          document.getElementById('nueva-ciudad').value = '';
          document.getElementById('nueva-cp').value = '';
          document.getElementById('nueva-pais').value = '';
          
          // Recargar direcciones
          const nombre = document.getElementById('modal-direcciones-cliente-nombre').textContent.split(' ')[0];
          const apellido = document.getElementById('modal-direcciones-cliente-nombre').textContent.split(' ')[1];
          verDirecciones(clienteId, nombre, apellido);
          
          alert('‚úÖ Direcci√≥n creada exitosamente');
        } else {
          alert('Error al crear la direcci√≥n');
        }
      } catch (error) {
        console.error('Error al crear direcci√≥n:', error);
        alert('Error al crear la direcci√≥n');
      }
    }

    function editarDireccionPorIndice(indice) {
      if (!window.direccionesActuales || !window.direccionesActuales[indice]) {
        alert('Error: No se pudo cargar la direcci√≥n');
        return;
      }
      
      const direccion = window.direccionesActuales[indice];
      editarDireccion(direccion);
    }

    function editarDireccion(direccion) {
      // Llenar el formulario con los datos de la direcci√≥n
      document.getElementById('edit-dir-id').value = direccion.direccion_id;
      document.getElementById('edit-dir-direccion').value = direccion.direccion_linea_1;
      document.getElementById('edit-dir-ciudad').value = direccion.ciudad;
      document.getElementById('edit-dir-cp').value = direccion.codigo_postal;
      document.getElementById('edit-dir-pais').value = direccion.pais;
      
      // Abrir modal de edici√≥n
      document.getElementById('modal-editar-direccion').classList.remove('hidden');
    }

    async function actualizarDireccion() {
      const direccionId = document.getElementById('edit-dir-id').value;
      const direccion = document.getElementById('edit-dir-direccion').value;
      const ciudad = document.getElementById('edit-dir-ciudad').value;
      const cp = document.getElementById('edit-dir-cp').value;
      const pais = document.getElementById('edit-dir-pais').value;

      if (!direccion || !ciudad || !cp || !pais) {
        alert('Por favor completa todos los campos');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('_method', 'PUT');
        formData.append('direccion_id', direccionId);
        formData.append('direccion_linea_1', direccion);
        formData.append('ciudad', ciudad);
        formData.append('codigo_postal', cp);
        formData.append('pais', pais);

        const response = await fetch('/api/direcciones', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          // Cerrar modal de edici√≥n
          document.getElementById('modal-editar-direccion').classList.add('hidden');
          
          // Recargar direcciones
          const clienteId = document.getElementById('modal-direcciones-cliente-id').value;
          const nombre = document.getElementById('modal-direcciones-cliente-nombre').textContent.split(' ')[0];
          const apellido = document.getElementById('modal-direcciones-cliente-nombre').textContent.split(' ')[1];
          verDirecciones(clienteId, nombre, apellido);
          
          alert('‚úÖ Direcci√≥n actualizada exitosamente');
        } else {
          alert('Error al actualizar la direcci√≥n');
        }
      } catch (error) {
        console.error('Error al actualizar direcci√≥n:', error);
        alert('Error al actualizar la direcci√≥n');
      }
    }

    // Cerrar modales con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('modal-crear').classList.add('hidden');
        document.getElementById('modal-editar').classList.add('hidden');
        document.getElementById('modal-direcciones').classList.add('hidden');
        document.getElementById('modal-editar-direccion').classList.add('hidden');
      }
    });

    // Cerrar modales al hacer clic fuera
    ['modal-crear', 'modal-editar', 'modal-direcciones', 'modal-editar-direccion'].forEach(modalId => {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target.id === modalId) {
            e.target.classList.add('hidden');
          }
        });
      }
    });
  </script>
</Layout>
